<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Inbox | Stick Arc</title>
<link rel="icon" href="favicon.ico.png">

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f0f2f5;
}

.inbox-container {
  max-width: 600px;
  margin: 50px auto;
  background: white;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.message {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px;
  border-radius: 10px;
  cursor: pointer;
}

.message:hover {
  background: #f5f5f5;
}

.message img {
  width: 50px;
  height: 50px;
  border-radius: 50%;
}

.message-content {
  flex: 1;
}

.last-text {
  color: #555;
  font-size: 14px;
}

.badge {
  background: red;
  color: white;
  border-radius: 50%;
  padding: 4px 8px;
  font-size: 12px;
}
</style>
</head>

<body>

<div class="inbox-container">
  <h2>Inbox</h2>
  <div id="messages"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAIgpVbHc_xdeTb02V_KE13MvxTmWKOSLM",
  authDomain: "stickarc-dcbc9.firebaseapp.com",
  projectId: "stickarc-dcbc9"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

auth.onAuthStateChanged(user=>{
  if(!user){
    location.href="login.html";
    return;
  }
  loadInbox(user.uid);
});

function loadInbox(myUID){
  const inbox = document.getElementById("messages");
  inbox.innerHTML = "Loading...";

  db.collection("messages")
    .where("receiverId","==",myUID)
    .orderBy("timestamp","desc")
    .onSnapshot(async snap=>{

      inbox.innerHTML = "";
      const shownSenders = new Set();

      for(const d of snap.docs){
        const msg = d.data();
        if(shownSenders.has(msg.senderId)) continue;
        shownSenders.add(msg.senderId);

        // ðŸ”¹ sender profile
        const userSnap = await db.collection("users")
          .where("uid","==",msg.senderId)
          .get();

        if(userSnap.empty) continue;
        const sender = userSnap.docs[0].data();

        // ðŸ”´ unread count
        const unreadSnap = await db.collection("messages")
          .where("receiverId","==",myUID)
          .where("senderId","==",msg.senderId)
          .where("unread","==",true)
          .get();

        const unreadCount = unreadSnap.size;

        const div = document.createElement("div");
        div.className = "message";

        div.innerHTML = `
          <img src="${sender.avatar || 'default-avatar.png'}">

          <div class="message-content">
            <strong>${sender.username}</strong><br>
            <span class="last-text">${msg.text}</span>
          </div>

          ${unreadCount > 0 ? `<span class="badge">${unreadCount}</span>` : ""}
        `;

        div.onclick = ()=>{
          location.href = "message.html?to=" + sender.username;
        };

        inbox.appendChild(div);
      }

      if(inbox.innerHTML===""){
        inbox.innerHTML="<p>No messages yet</p>";
      }
    });
}
</script>

</body>
</html>
